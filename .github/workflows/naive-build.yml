name: Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release tag'
        type: string
        required: false
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  android:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            cc: aarch64-linux-android23-clang
          - arch: amd64
            cc: x86_64-linux-android23-clang
          - arch: arm
            cc: armv7a-linux-androideabi23-clang
          - arch: "386"
            cc: i686-linux-android23-clang
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - uses: actions/setup-go@v5
        with:
          go-version: ^1.22
      - name: Get naiveproxy commit
        id: naive
        run: echo "commit=$(git -C naiveproxy rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: Get Chromium version
        id: chromium
        run: echo "version=$(cat naiveproxy/CHROMIUM_VERSION)" >> $GITHUB_OUTPUT
      - name: Cache build artifacts
        id: build-cache
        uses: actions/cache@v4
        with:
          path: naiveproxy/src/out
          key: naive-build-${{ steps.naive.outputs.commit }}-${{ hashFiles('cmd/build-naive/cmd_build.go', 'cmd/build-naive/cmd.go') }}-android-${{ matrix.arch }}
      - name: Cache ccache files
        if: steps.build-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-android-${{ matrix.arch }}-${{ steps.chromium.outputs.version }}
          restore-keys: ccache-android-${{ matrix.arch }}-
      - name: Install packages
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt update
          sudo apt install -y ninja-build ccache
      - name: Reset ccache stats
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: ccache -z
      - name: Build
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: go run ./cmd/build-naive --target=android/${{ matrix.arch }} build
      - name: Show ccache stats
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: ccache -s
      - name: Package
        run: |
          go run ./cmd/build-naive --target=android/${{ matrix.arch }} package --local
          go run ./cmd/build-naive --target=android/${{ matrix.arch }} package
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r28
      - name: Build test binary
        run: |
          CC=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.cc }} \
          CGO_ENABLED=1 GOOS=android GOARCH=${{ matrix.arch }} go test -c -o cronet.test .
      - uses: actions/upload-artifact@v4
        with:
          name: cronet-android-${{ matrix.arch }}
          path: |
            lib/
            include/
            include_cgo.go

  publish:
    if: github.event_name == 'push'
    needs: [android]
    runs-on: ubuntu-22.04
    env:
      TARGET_BRANCH: ${{ github.ref_name == 'main' && 'go' || 'go_dev' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ^1.22

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Merge artifacts
        run: |
          for dir in artifacts/cronet-*/; do
            cp -r "$dir"/* .
          done
          ls -laR lib/ include/ include_cgo.go

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Publish
        run: go run ./cmd/build-naive publish --branch ${{ env.TARGET_BRANCH }}
